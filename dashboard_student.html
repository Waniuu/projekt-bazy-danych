<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Studenta</title>
    <link rel="stylesheet" href="templatemo-noir-fashion.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<style>
/* KARTA DANYCH STUDENTA */
.student-info-card {
    background: rgba(255,255,255,0.08);
    padding: 25px;
    border-radius: 18px;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 4px 18px rgba(0,0,0,0.4);
    transition: .3s;
}
.student-info-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 25px rgba(0,0,0,0.45);
}
.student-info-card h3 {
    margin-bottom: 15px;
    color: #ff3366;
    border-bottom: 1px solid #ff336655;
    padding-bottom: 6px;
    font-size: 22px;
}

/* OSTATNIE WYNIKI – GRID */
#wynikiContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 20px;
}

/* KARTA WYNIKU */
.result-card {
    background: rgba(255,255,255,0.06);
    padding: 18px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    transition: .3s;
    backdrop-filter: blur(6px);
}
.result-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 25px rgba(0,0,0,0.45);
}

.result-title {
    font-size: 18px;
    font-weight: bold;
    color: #ff3366;
    margin-bottom: 10px;
}

.result-line {
    margin-bottom: 4px;
    font-size: 14px;
}
.result-points {
    color: #ff3366;
    font-weight: bold;
}

.kategoria-naglowek {
    width: 100%;
    grid-column: 1/-1;
    margin-top: 25px;
    color: #ff3366;
    font-size: 22px;
    font-weight: bold;
    border-bottom: 1px solid #ff336666;
    padding-bottom: 5px;
}<style>
.stats-panel {
    background: rgba(255,255,255,0.06);
    padding: 20px;
    border-radius: 18px;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 4px 18px rgba(0,0,0,0.35);
    color: white;
}

.stats-title {
    color: #ff3366;
    font-size: 22px;
    margin-bottom: 10px;
}

.progress-bar-bg {
    width: 100%;
    height: 16px;
    border-radius: 10px;
    background: rgba(255,255,255,0.2);
    overflow: hidden;
    margin-top: 10px;
}
.progress-bar-fill {
    height: 100%;
    background: linear-gradient(to right, #ff3366, #ff6699);
    width: 0%;
    border-radius: 10px;
    transition: width .6s ease;
}

.rank-list {
    margin-top: 10px;
}
.rank-item {
    margin-bottom: 6px;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
}

.canvas-container {
    margin-top: 18px;
    width: 100%;
}
</style>

</style>

<body>
<nav id="navbar">
    <div class="nav-container">
        <a href="index.html" class="logo-link">
            <svg class="logo-svg" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fff" />
                        <stop offset="100%" style="stop-color:#ff3366" />
                    </linearGradient>
                </defs>
                <polygon points="50,10 20,50 50,90 80,50" fill="none" stroke="url(#logoGrad)" stroke-width="3"/>
                <circle cx="50" cy="50" r="5" fill="url(#logoGrad)"/>
            </svg>
            <span class="logo-text">Panel Studenta</span>
        </a>

        <ul class="nav-links">
            <li><a class="nav-link active">Dashboard</a></li>
            <li><a class="nav-cta" onclick="logout()">Wyloguj</a></li>
        </ul>
    </div>
</nav>

<section class="hero">
    <div class="hero-bg"></div>
    <div class="hero-container">

        <div class="hero-left">
            <h1 class="hero-title">
                <span class="line"><span><span class="accent">Twoje</span></span></span>
                <span class="line"><span>testy</span></span>
            </h1>
            <p class="hero-description">Masz wszystko pod ręką</p>
        </div>

        <div class="hero-right">
            <div class="student-info-card"
                 style="background:rgba(255,255,255,0.08);padding:20px;border-radius:15px;backdrop-filter:blur(5px);margin-bottom:20px;color:white;">

                <h3>Twoje dane</h3>

                <p><b>Imię:</b> <span id="studentImie"></span></p>
                <p><b>Nazwisko:</b> <span id="studentNazwisko"></span></p>
                <p><b>Email:</b> <span id="studentEmail"></span></p>
                <p><b>Numer indeksu:</b> <span id="studentIndeks"></span></p>
                <p><b>Średnia ocen:</b> <span id="studentSrednia" style="color:#ff3366;font-weight:bold;"></span></p>

            </div>
        </div>

    </div>
</section>

<section class="collections">
    <div class="section-header">
        <h2 class="section-title">Kategorie testów</h2>
        <p class="section-subtitle">Wybierz kategorię aby rozpocząć</p>
    </div>

    <div class="grid" id="collectionsGrid"></div>

    <div class="grid" id="extraCategories" style="display:none;margin-top:20px;"></div>
</section>

<section class="featured">
    <div class="featured-container">
        <div class="featured-hero">
            <div class="featured-content">
                <span class="label">Ucz się bez limitu</span>
                <h2>Ostatnie wyniki</h2>
                <p>Historia twoich testów</p>

                <div class="testimonials">
                    <div class="testimonials-grid" id="wynikiContainer">Ładowanie wyników...</div>
                    <div class="stats-panel" id="statsPanel">

    <div class="stats-title">Progres nauki</div>
    <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progressFill"></div>
    </div>

    <div class="stats-title" style="margin-top:20px;">Ranking kategorii</div>
    <div class="rank-list" id="rankList">Ładowanie...</div>

    <div class="stats-title" style="margin-top:20px;">Wykres wyników</div>
    <div class="canvas-container">
        <canvas id="resultsChart"></canvas>
    </div>

</div>

                </div>

            </div>
        </div>
    </div>
</section>

<script>
// -----------------------------------------
// NORMALIZACJA NAZWY KATEGORII → PLIK PNG
// -----------------------------------------
function normalizeName(name) {
    return name
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")  // usuwa ogonki
        .replaceAll(" ", "_");           // spacje → _
}

// -----------------------------------------
function logout() {
    localStorage.removeItem("user");
    window.location.href = "logowanie.html";
}

// -----------------------------------------
async function loadStudentInfo(userId) {
    const data = await fetch(
        `https://projekt-bazy-danych-backend.onrender.com/api/uzytkownicy/${userId}`
    ).then(r => r.json());

    document.getElementById("studentImie").textContent = data.imie;
    document.getElementById("studentNazwisko").textContent = data.nazwisko;
    document.getElementById("studentEmail").textContent = data.email;
    document.getElementById("studentIndeks").textContent = data.numer_indeksu ?? "—";

    const wyniki = await fetch(
        `https://projekt-bazy-danych-backend.onrender.com/api/wyniki/${userId}`
    ).then(r => r.json());

    if (!wyniki.length) {
        document.getElementById("studentSrednia").textContent = "Brak danych";
        return;
    }

    const oceny = wyniki.map(w => Number(w.ocena)).filter(n => !isNaN(n));
    if (!oceny.length) return (document.getElementById("studentSrednia").textContent = "Brak danych");

    const avg = oceny.reduce((a,b)=>a+b,0) / oceny.length;
    document.getElementById("studentSrednia").textContent = avg.toFixed(2);
}

// -----------------------------------------
async function loadResults(userId) {
    let response = await fetch(
        `https://projekt-bazy-danych-backend.onrender.com/api/wyniki/${userId}`
    );

    const wynikiDiv = document.getElementById("wynikiContainer");

    if (!response.ok) {
        wynikiDiv.innerHTML = "<p>Błąd ładowania wyników.</p>";
        return;
    }

    const wyniki = await response.json();
    wynikiDiv.innerHTML = "";

    if (!wyniki.length) {
        wynikiDiv.innerHTML = "<p>Brak wyników.</p>";
        return;
    }

    wyniki.sort((a,b)=>a.nazwa_testu.localeCompare(b.nazwa_testu));

    const grupy = {};
    wyniki.forEach(w => {
        if (!grupy[w.nazwa_testu]) grupy[w.nazwa_testu] = [];
        grupy[w.nazwa_testu].push(w);
    });

for (const [kat, lista] of Object.entries(grupy)) {

    wynikiDiv.innerHTML += `
        <div class="kategoria-naglowek">${kat}</div>
    `;

    lista.forEach(w => {
        wynikiDiv.innerHTML += `
            <div class="result-card">
                <div class="result-title">${w.nazwa_testu}</div>
                <div class="result-line">Ocena: ⭐ ${w.ocena}</div>
                <div class="result-line">Punkty: 
                    <span class="result-points">${w.liczba_punktow}</span>
                </div>
                <div class="result-line">Data: ${w.data}</div>
            </div>
        `;
    });
}

}
function updateStats(wyniki) {
    if (!wyniki.length) return;

    // =============================
    // PROGRES – na podstawie średniej %
    // =============================
    const oceny = wyniki.map(w => Number(w.ocena));
    let avg = oceny.reduce((a,b)=>a+b,0) / oceny.length;
    document.getElementById("progressFill").style.width = (avg*10) + "%";

    // =============================
    // RANKING KATEGORII
    // =============================
    let kategorie = {};

    wyniki.forEach(w => {
        if (!kategorie[w.nazwa_testu]) kategorie[w.nazwa_testu] = [];
        kategorie[w.nazwa_testu].push(Number(w.ocena));
    });

    let ranking = Object.entries(kategorie)
        .map(([kat, oceny]) => ({
            kat,
            avg: oceny.reduce((a,b)=>a+b,0) / oceny.length
        }))
        .sort((a,b)=>b.avg - a.avg);

    let rankDiv = document.getElementById("rankList");
    rankDiv.innerHTML = "";
    ranking.forEach((r,i) => {
        rankDiv.innerHTML += `
            <div class="rank-item">
                <span>${i+1}. ${r.kat}</span>
                <span style="color:#ff3366">${r.avg.toFixed(2)}</span>
            </div>
        `;
    });

    // =============================
    // WYKRES WYNIKÓW
    // =============================
    const ctx = document.getElementById('resultsChart').getContext('2d');
    const labels = wyniki.map(w => w.data);
    const points = wyniki.map(w => Number(w.ocena));

    new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Oceny',
                data: points,
                borderWidth: 3,
                tension: 0.3
            }]
        },
        options: {
            plugins: { legend: { labels: { color:"white" }}},
            scales: {
                x: { ticks: { color:"white" }},
                y: { ticks: { color:"white" }}
            }
        }
    });
}

// -----------------------------------------
async function loadCategories() {
    const categories = await fetch(
        "https://projekt-bazy-danych-backend.onrender.com/api/kategorie"
    ).then(r => r.json());

    const grid = document.getElementById("collectionsGrid");
    const extraGrid = document.getElementById("extraCategories");

    grid.innerHTML = "";
    extraGrid.innerHTML = "";

    const first3 = categories.slice(0,3);
    const rest = categories.slice(3);

    // ---- pierwsze 3 kategorie ----
    first3.forEach(cat => {
        const imgName = normalizeName(cat.nazwa);

        grid.innerHTML += `
        <div class="collection-card">
            <div class="collection-thumbnail">
                <img src="images/${imgName}.png" onerror="this.src='images/default.png'">
            </div>
            <div class="card-content">
                <h3 class="card-title">${cat.nazwa}</h3>
                <p class="card-subtitle">${cat.opis || ""}</p>
                <a href="start.html?id=${cat.id_kategorii}" class="cta-button primary">Rozpocznij</a>
            </div>
        </div>`;
    });

    // ---- karta rozwijania ----
    grid.innerHTML += `
    <div class="collection-card" id="expandCard" style="cursor:pointer;">
        <div class="collection-thumbnail">
            <img src="images/default.png">
        </div>
        <div class="card-content">
            <h3 class="card-title" id="expandLabel">Rozwiń wszystkie kategorie ↓</h3>
            <p class="card-subtitle">Kliknij, aby zobaczyć więcej</p>
        </div>
    </div>`;

    // ---- ukryte kategorie ----
    rest.forEach(cat => {
        const imgName = normalizeName(cat.nazwa);

        extraGrid.innerHTML += `
        <div class="collection-card">
            <div class="collection-thumbnail">
                <img src="images/${imgName}.png" onerror="this.src='images/default.png'">
            </div>
            <div class="card-content">
                <h3 class="card-title">${cat.nazwa}</h3>
                <p class="card-subtitle">${cat.opis || ""}</p>
                <a href="start.html?id=${cat.id_kategorii}" class="cta-button primary">Rozpocznij</a>
            </div>
        </div>`;
    });

    // ---- obsługa rozwijania ----
    let expanded = false;
    document.getElementById("expandCard").onclick = () => {
        expanded = !expanded;
        extraGrid.style.display = expanded ? "grid" : "none";
        document.getElementById("expandLabel").textContent =
            expanded ? "Zwiń kategorie ↑" : "Rozwiń wszystkie kategorie ↓";
    };
}

// -----------------------------------------
async function initDashboard() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) return logout();

    loadStudentInfo(user.id);
    loadResults(user.id);
    loadCategories();
    updateStats(wyniki);

}

initDashboard();
</script>

</body>
</html>


