<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Studenta</title>
    <link rel="stylesheet" href="templatemo-noir-fashion.css">
</head>

<body>
<nav id="navbar">
    <div class="nav-container">
        <a href="index.html" class="logo-link">
            <svg class="logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fff;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ff3366;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <polygon points="50,10 20,50 50,90 80,50" fill="none" stroke="url(#logoGrad)" stroke-width="3"/>
                <circle cx="50" cy="50" r="5" fill="url(#logoGrad)"/>
            </svg>
            <span class="logo-text">Panel Studenta</span>
        </a>

        <ul class="nav-links">
            <li><a class="nav-link active">Dashboard</a></li>
            <li><a class="nav-cta" onclick="logout()">Wyloguj</a></li>
        </ul>
    </div>
</nav>

<section class="hero" id="home">
    <div class="hero-bg"></div>
    <div class="hero-container">

        <div class="hero-left">
            <h1 class="hero-title">
                <span class="line"><span><span class="accent">Twoje</span></span></span>
                <span class="line"><span>testy</span></span>
            </h1>
            <p class="hero-description">Masz wszystko pod ręką</p>
        </div>

        <div class="hero-right">
            <div class="student-info-card"
                 style="background:rgba(255,255,255,0.08);padding:20px;border-radius:15px;backdrop-filter:blur(5px);margin-bottom:20px;color:white;">

                <h3 style="margin-bottom:10px;">Twoje dane</h3>

                <p><b>Imię:</b> <span id="studentImie"></span></p>
                <p><b>Nazwisko:</b> <span id="studentNazwisko"></span></p>
                <p><b>Email:</b> <span id="studentEmail"></span></p>
                <p><b>Numer indeksu:</b> <span id="studentIndeks"></span></p>
                <p><b>Średnia ocen:</b> <span id="studentSrednia" style="color:#ff3366;font-weight:bold;"></span></p>

            </div>
        </div>

    </div>
</section>

<section class="collections" id="collections">
    <div class="section-header">
        <h2 class="section-title">Kategorie testów</h2>
        <p class="section-subtitle">Wybierz kategorię aby rozpocząć</p>
    </div>

    <div class="grid" id="collectionsGrid"></div>

    <div class="grid" id="extraCategories" style="display:none; margin-top:20px;"></div>
</section>

<section class="featured" id="featured">
    <div class="featured-container">
        <div class="featured-hero">
            <div class="featured-content">
                <span class="label">Ucz się bez limitu</span>
                <h2>Ostatnie wyniki</h2>
                <p>Historia twoich testów</p>

                <div class="testimonials">
                    <div class="testimonials-grid" id="wynikiContainer">Ładowanie wyników...</div>
                </div>

            </div>
        </div>
    </div>
</section>

<script>
    function logout() {
        localStorage.removeItem("user");
        window.location.href = "logowanie.html";
    }

    // -------------------- ŁADOWANIE DANYCH STUDENTA --------------------
async function loadStudentInfo(userId) {
    const data = await fetch(
        `https://projekt-bazy-danych-backend.onrender.com/api/uzytkownicy/${userId}`
    ).then(r => r.json());

    document.getElementById("studentImie").textContent = data.imie;
    document.getElementById("studentNazwisko").textContent = data.nazwisko;
    document.getElementById("studentEmail").textContent = data.email;
    document.getElementById("studentIndeks").textContent = data.numer_indeksu ?? "—";

    const wyniki = await fetch(
        `https://projekt-bazy-danych-backend.onrender.com/api/wyniki/${userId}`
    ).then(r => r.json());

    if (!wyniki.length) {
        document.getElementById("studentSrednia").textContent = "Brak danych";
        return;
    }

    const oceny = wyniki
        .map(w => Number(w.ocena))
        .filter(n => !isNaN(n));

    if (!oceny.length) {
        document.getElementById("studentSrednia").textContent = "Brak danych";
        return;
    }

    const avg = oceny.reduce((a, b) => a + b, 0) / oceny.length;
    document.getElementById("studentSrednia").textContent = avg.toFixed(2);
}

    // -------------------- ŁADOWANIE WYNIKÓW --------------------
async function loadResults(userId) {
    const wynikiDiv = document.getElementById("wynikiContainer");

    let response = await fetch(
        `https://projekt-bazy-danych-backend.onrender.com/api/wyniki/${userId}`
    );

    if (!response.ok) {
        wynikiDiv.innerHTML = "<p>Nie udało się załadować wyników.</p>";
        return;
    }

    const wyniki = await response.json();

    wynikiDiv.innerHTML = "";

    if (!wyniki.length) {
        wynikiDiv.innerHTML = "<p>Brak wyników.</p>";
        return;
    }

    wyniki.sort((a, b) => a.nazwa_testu.localeCompare(b.nazwa_testu));

    const grupy = {};
    for (const w of wyniki) {
        if (!grupy[w.nazwa_testu]) grupy[w.nazwa_testu] = [];
        grupy[w.nazwa_testu].push(w);
    }

    for (const [kategoria, lista] of Object.entries(grupy)) {
        wynikiDiv.innerHTML += `
            <h3 style="margin-top:20px;color:#ff3366;border-bottom:1px solid #ff336666;padding-bottom:5px;">
                ${kategoria}
            </h3>
        `;

        lista.forEach(w => {
            wynikiDiv.innerHTML += `
                <div class="testimonial-card">
                    <div class="testimonial-rating">⭐ ${w.ocena}</div>
                    <div class="testimonial-quote">
                        <b>${w.nazwa_testu}</b><br>
                        Punkty: <span style="color:#ff3366;font-weight:bold;">${w.liczba_punktow}</span><br>
                        Data: ${w.data}
                    </div>
                </div>
            `;
        });
    }
}

    // -------------------- KATEGORIE --------------------
async function loadCategories() {
    const categories = await fetch(
        "https://projekt-bazy-danych-backend.onrender.com/api/kategorie"
    ).then(r => r.json());

    const grid = document.getElementById("collectionsGrid");
    const extraGrid = document.getElementById("extraCategories");

    grid.innerHTML = "";
    extraGrid.innerHTML = "";

    const pierwsze3 = categories.slice(0, 3);
    const pozostale = categories.slice(3);

    // --- 3 pierwsze kategorie ---
    pierwsze3.forEach(cat => {
  grid.innerHTML += `
<div class="collection-card">
    <div class="collection-thumbnail">
        <img src="images/${cat.nazwa.replaceAll(' ', '_')}.jpg" onerror="this.src='images/default.jpg'">
    </div>
    <div class="card-content">
        <h3 class="card-title">${cat.nazwa}</h3>
        <p class="card-subtitle">${cat.opis || ""}</p>
        <a href="start.html?id=${cat.id_kategorii}" class="cta-button primary">Rozpocznij</a>
    </div>
</div>
`;
    });

    // --- karta rozwijania ---
    grid.innerHTML += `
    <div class="collection-card" id="expandCard" style="cursor:pointer;">
        <div class="collection-thumbnail">
              <img src="images/${cat.nazwa.replaceAll(' ', '_')}.jpg" onerror="this.src='images/default.jpg'">
        </div>
        <div class="card-content">
            <h3 class="card-title" id="expandLabel">Rozwiń wszystkie kategorie ↓</h3>
            <p class="card-subtitle">Kliknij, aby zobaczyć więcej</p>
        </div>
    </div>`;

    // --- ukryte kategorie ---
    extraGrid.classList.add("grid");
    extraGrid.style.display = "none";

extraGrid.innerHTML = pozostale.map(cat => `
    <div class="collection-card">
        <div class="collection-thumbnail">
             <img src="images/expand.jpg">
        </div>
        <div class="card-content">
            <h3 class="card-title">${cat.nazwa}</h3>
            <p class="card-subtitle">${cat.opis || ""}</p>
            <a href="start.html?id=${cat.id_kategorii}" class="cta-button primary">Rozpocznij</a>
        </div>
    </div>
`).join("");

    // --- obsługa rozwijania ---
    let expanded = false;

    document.getElementById("expandCard").onclick = () => {
        expanded = !expanded;

        extraGrid.style.display = expanded ? "grid" : "none";

        document.getElementById("expandLabel").textContent =
            expanded ? "Zwiń kategorie ↑" : "Rozwiń wszystkie kategorie ↓";
    };
}

    // -------------------- START --------------------
async function initDashboard() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) return logout();

    loadStudentInfo(user.id);
    loadResults(user.id);
    loadCategories();
}

initDashboard();
</script>

</body>
</html>


