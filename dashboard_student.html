<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Panel Studenta</title>
    <link rel="stylesheet" href="templatemo-noir-fashion.css">
    
    <style>
    /* UPROSZCZONY LAYOUT - brak podziału na kolumny */
    .featured-hero {
        display: block; /* Zmieniono z grid na block */
        width: 100%;
    }

    /* KARTA DANYCH STUDENTA */
    .student-info-card {
        background: rgba(255,255,255,0.08);
        padding: 25px;
        border-radius: 18px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 4px 18px rgba(0,0,0,0.4);
        transition: .3s;
        color: white;
    }
    .student-info-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(0,0,0,0.45);
    }
    .student-info-card h3 {
        margin-bottom: 12px;
        color: #ff3366;
        border-bottom: 1px solid #ff336655;
        padding-bottom: 6px;
        font-size: 20px;
    }

    /* OSTATNIE WYNIKI – GRID */
    /* Teraz zajmują całą szerokość i jest ich więcej w rzędzie */
    #wynikiContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Szersze karty */
        gap: 20px;
        margin-top: 20px;
    }

    /* KARTA WYNIKU */
    .result-card {
        background: rgba(255,255,255,0.06);
        padding: 20px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.08);
        color: white;
        transition: .22s;
        backdrop-filter: blur(6px);
    }
    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.45);
        background: rgba(255,255,255,0.1);
    }

    .result-title {
        font-size: 18px;
        font-weight: 700;
        color: #ff3366;
        margin-bottom: 10px;
        min-height: 44px; /* Żeby karty były równe przy długich tytułach */
    }

    .result-line {
        margin-bottom: 6px;
        font-size: 15px;
        color: #e9e9e9;
    }
    .result-points { color: #ff3366; font-weight: 700; }

    .kategoria-naglowek {
        width: 100%;
        grid-column: 1/-1;
        margin-top: 30px;
        margin-bottom: 10px;
        color: #ff3366;
        font-size: 22px;
        font-weight: 700;
        border-bottom: 1px solid #ff336666;
        padding-bottom: 8px;
    }

    /* --- Panel statystyk ZOSTAŁ USUNIĘTY --- */

    /* drobne elementy */
    .label { color:#ff9ab7; font-weight:700; font-size:14px; display:block; margin-bottom:5px; }
    h2 { margin-top: 0; color: #fff; font-size: 32px;}
    p.section-subtitle { color: #dcdcdc; margin-bottom: 20px; font-size: 16px; }
    </style>
</head>
<body>
<nav id="navbar">
    <div class="nav-container">
        <a href="index.html" class="logo-link">
            <svg class="logo-svg" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fff" />
                        <stop offset="100%" style="stop-color:#ff3366" />
                    </linearGradient>
                </defs>
                <polygon points="50,10 20,50 50,90 80,50" fill="none" stroke="url(#logoGrad)" stroke-width="3"/>
                <circle cx="50" cy="50" r="5" fill="url(#logoGrad)"/>
            </svg>
            <span class="logo-text">Panel Studenta</span>
        </a>

        <ul class="nav-links">
            <li><a class="nav-link active">Dashboard</a></li>
            <li><a class="nav-cta" onclick="logout()">Wyloguj</a></li>
        </ul>
    </div>
</nav>

<section class="hero">
    <div class="hero-bg"></div>
    <div class="hero-container">
        <div class="hero-left">
            <h1 class="hero-title">
                <span class="line"><span><span class="accent">Twoje</span></span></span>
                <span class="line"><span>testy</span></span>
            </h1>
            <p class="hero-description">Masz wszystko pod ręką</p>
        </div>

        <div class="hero-right">
            <div class="student-info-card">
                <h3>Twoje dane</h3>
                <p><b>Imię:</b> <span id="studentImie">—</span></p>
                <p><b>Nazwisko:</b> <span id="studentNazwisko">—</span></p>
                <p><b>Email:</b> <span id="studentEmail">—</span></p>
                <p><b>Numer indeksu:</b> <span id="studentIndeks">—</span></p>
                <p><b>Średnia ocen:</b> <span id="studentSrednia" style="color:#ff3366;font-weight:700;">Obliczam...</span></p>
            </div>
        </div>
    </div>
</section>

<section class="collections">
    <div class="section-header">
        <h2 class="section-title">Kategorie testów</h2>
        <p class="section-subtitle">Wybierz kategorię aby rozpocząć</p>
    </div>

    <div class="grid" id="collectionsGrid"></div>
    <div class="grid" id="extraCategories" style="display:none;margin-top:20px;"></div>
</section>

<section class="featured">
    <div class="featured-container">
        <div class="featured-hero"> <div class="featured-content" style="width: 100%;">
                <span class="label">Ucz się bez limitu</span>
                <h2>Ostatnie wyniki</h2>
                <p class="section-subtitle">Historia twoich testów</p>

                <div id="wynikiWrapper">
                    <div id="wynikiContainer">Ładowanie wyników...</div>
                </div>
            </div>

            </div> 
    </div>
</section>

<script>
/* -------------------------
   Utility / helpers
   ------------------------- */
function normalizeName(name) {
    return name
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replaceAll(" ", "_");
}

function logout() {
    localStorage.removeItem("user");
    window.location.href = "logowanie.html";
}

/* -------------------------
   Pobieranie i wypełnianie danych studenta
   ------------------------- */
async function loadStudentInfo(userId) {
    try {
        const res = await fetch(`https://projekt-bazy-danych-backend.onrender.com/api/uzytkownicy/${userId}`);
        if (!res.ok) throw new Error("Błąd pobierania danych studenta");
        const data = await res.json();

        document.getElementById("studentImie").textContent = data.imie || "—";
        document.getElementById("studentNazwisko").textContent = data.nazwisko || "—";
        document.getElementById("studentEmail").textContent = data.email || "—";
        document.getElementById("studentIndeks").textContent = data.numer_indeksu ?? "—";
        
        // Średnia zostanie uzupełniona w loadResults(), bo stamtąd mamy oceny
    } catch (e) {
        console.warn(e);
    }
}

/* -------------------------
   Wyniki, grupowanie, rendering kart
   ------------------------- */

function renderResultsCards(wyniki) {
    const wynikiDiv = document.getElementById("wynikiContainer");
    wynikiDiv.innerHTML = "";

    if (!wyniki || !wyniki.length) {
        wynikiDiv.innerHTML = "<p>Brak wyników.</p>";
        return;
    }

    // grupuj według nazwy testu (kategorii)
    const grupy = {};
    wyniki.forEach(w => {
        const key = w.nazwa_testu || "Inne"; // Używamy pola nazwa_testu z API
        if (!grupy[key]) grupy[key] = [];
        grupy[key].push(w);
    });

    // sortuj kategorie alfabetycznie
    const sortedKeys = Object.keys(grupy).sort((a,b)=> a.localeCompare(b,'pl'));

    sortedKeys.forEach(kat => {
        wynikiDiv.insertAdjacentHTML('beforeend', `<div class="kategoria-naglowek">${kat}</div>`);
        grupy[kat].forEach(w => {
            const dataDisplay = w.data || "";
            const ocena = (w.ocena !== undefined && w.ocena !== null) ? w.ocena : "—";
            const pkt = (w.liczba_punktow !== undefined && w.liczba_punktow !== null) ? w.liczba_punktow : "—";

            wynikiDiv.insertAdjacentHTML('beforeend', `
                <div class="result-card">
                    <div class="result-title">${w.nazwa_testu || "Test"}</div>
                    <div class="result-line">Ocena: ⭐ <span style="font-size:1.2em;font-weight:bold">${ocena}</span></div>
                    <div class="result-line">Punkty: <span class="result-points">${pkt}</span></div>
                    <div class="result-line">Data: ${dataDisplay}</div>
                </div>
            `);
        });
    });
}

// NOWA FUNKCJA DO OBLICZANIA ŚREDNIEJ
function calculateAverage(wyniki) {
    if (!wyniki || wyniki.length === 0) {
        document.getElementById("studentSrednia").textContent = "Brak ocen";
        return;
    }

    let suma = 0;
    let licznik = 0;

    wyniki.forEach(w => {
        // Konwertujemy ocenę na liczbę (zakładamy format "4", "4.5" lub "5")
        const ocena = parseFloat(w.ocena);
        if (!isNaN(ocena) && ocena > 0) {
            suma += ocena;
            licznik++;
        }
    });

    if (licznik > 0) {
        const srednia = (suma / licznik).toFixed(2); // Dwa miejsca po przecinku
        document.getElementById("studentSrednia").textContent = srednia;
    } else {
        document.getElementById("studentSrednia").textContent = "—";
    }
}


/* -------------------------
   Funkcja ładująca wyniki i wywołująca render
   ------------------------- */
async function loadResults(userId) {
    const wynikiDiv = document.getElementById("wynikiContainer");
    wynikiDiv.innerHTML = "Ładowanie wyników...";

    try {
        const res = await fetch(`https://projekt-bazy-danych-backend.onrender.com/api/wyniki/${userId}`);
        if (!res.ok) throw new Error("Błąd żądania wyników");
        const wyniki = await res.json();

        if (!wyniki || !wyniki.length) {
            wynikiDiv.innerHTML = "<p>Brak wyników.</p>";
            document.getElementById("studentSrednia").textContent = "Brak ocen";
            return;
        }

        // 1. Render kart
        renderResultsCards(wyniki);

        // 2. Oblicz i wyświetl średnią
        calculateAverage(wyniki);

    } catch (e) {
        console.warn(e);
        wynikiDiv.innerHTML = "<p>Błąd ładowania wyników.</p>";
        document.getElementById("studentSrednia").textContent = "Błąd";
    }
}

/* -------------------------
   KATEGORIE
   ------------------------- */
async function loadCategories() {
    try {
        const categories = await fetch("https://projekt-bazy-danych-backend.onrender.com/api/kategorie").then(r => r.json());

        const grid = document.getElementById("collectionsGrid");
        const extraGrid = document.getElementById("extraCategories");

        grid.innerHTML = "";
        extraGrid.innerHTML = "";

        const first3 = categories.slice(0,3);
        const rest = categories.slice(3);

        first3.forEach(cat => {
            const imgName = normalizeName(cat.nazwa);
            grid.insertAdjacentHTML('beforeend', `
                <div class="collection-card">
                    <div class="collection-thumbnail">
                        <img src="images/${imgName}.png" onerror="this.src='images/default.png'">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">${cat.nazwa}</h3>
                        <p class="card-subtitle">${cat.opis || ""}</p>
                        <a href="start.html?id=${cat.id_kategorii}" class="cta-button primary">Rozpocznij</a>
                    </div>
                </div>
            `);
        });

        if (rest.length > 0) {
            grid.insertAdjacentHTML('beforeend', `
                <div class="collection-card" id="expandCard" style="cursor:pointer;">
                    <div class="collection-thumbnail"><img src="images/default.png"></div>
                    <div class="card-content">
                        <h3 class="card-title" id="expandLabel">Rozwiń wszystkie kategorie ↓</h3>
                        <p class="card-subtitle">Kliknij, aby zobaczyć więcej</p>
                    </div>
                </div>
            `);
        }

        rest.forEach(cat => {
            const imgName = normalizeName(cat.nazwa);
            extraGrid.insertAdjacentHTML('beforeend', `
                <div class="collection-card">
                    <div class="collection-thumbnail">
                        <img src="images/${imgName}.png" onerror="this.src='images/default.png'">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">${cat.nazwa}</h3>
                        <p class="card-subtitle">${cat.opis || ""}</p>
                        <a href="start.html?id=${cat.id_kategorii}" class="cta-button primary">Rozpocznij</a>
                    </div>
                </div>
            `);
        });

        let expanded = false;
        const expandCard = document.getElementById("expandCard");
        if (expandCard) {
            expandCard.onclick = () => {
                expanded = !expanded;
                extraGrid.style.display = expanded ? "grid" : "none";
                document.getElementById("expandLabel").textContent =
                    expanded ? "Zwiń kategorie ↑" : "Rozwiń wszystkie kategorie ↓";
            };
        }

    } catch (e) {
        console.warn("Błąd ładowania kategorii", e);
    }
}

/* -------------------------
   Inicjalizacja dashboardu
   ------------------------- */
async function initDashboard() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) return logout();

    const userId = user.id;
    // Ładujemy dane (bez średniej)
    loadStudentInfo(userId);
    
    // Ładujemy kategorie
    await loadCategories();
    
    // Ładujemy wyniki I OBLICZAMY ŚREDNIĄ
    await loadResults(userId);
}

initDashboard();
</script>

</body>
</html>
