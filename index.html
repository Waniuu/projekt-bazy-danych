<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Mini klient - system testów</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; max-width: 900px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    input, select, button, textarea { padding: 6px; font-size: 14px; width:100%; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f4f4f4; text-align:left; }
  </style>
</head>
<body>
  <h1>Klient - system generowania testów (demonst.)</h1>

  <section>
    <h2>Użytkownicy</h2>
    <div class="grid">
      <div>
        <input id="uzytk_q" placeholder="Szukaj po imieniu, nazwisku, email..." />
        <select id="uzytk_typ">
          <option value="">Wszystkie typy</option>
          <option value="student">Student</option>
          <option value="nauczyciel">Nauczyciel</option>
        </select>
        <button id="uzytk_szukaj">Szukaj</button>
      </div>
      <div>
        <input id="nowe_imie" placeholder="Imię" />
        <input id="nowe_nazwisko" placeholder="Nazwisko" />
        <input id="nowy_email" placeholder="Email" />
        <input id="nowe_haslo" placeholder="Hasło" />
        <select id="nowy_typ">
          <option value="student">student</option>
          <option value="nauczyciel">nauczyciel</option>
          <option value="administrator">administrator</option>
        </select>
        <button id="dodaj_uzytkownika">Dodaj użytkownika</button>
      </div>
    </div>

    <div id="uzytk_lista"></div>
  </section>

  <hr/>

  <section>
    <h2>Pytania</h2>
    <div class="grid">
      <div>
        <input id="pytanie_q" placeholder="Szukaj tekstu w pytaniu..." />
        <select id="pytanie_bank">
          <option value="">Bank (wszystkie)</option>
        </select>
        <button id="pytania_szukaj">Szukaj pytań</button>
      </div>
      <div>
        <textarea id="pytanie_tresc" placeholder="Treść pytania"></textarea>
        <input id="pytanie_trudnosc" placeholder="Trudność (liczba)" type="number" />
        <select id="pytanie_bank_select"></select>
        <select id="pytanie_kat_select"></select>
        <button id="dodaj_pytanie">Dodaj pytanie</button>
      </div>
    </div>
    <div id="pytania_lista"></div>
  </section>

  <script>
    const API = (window.location.hostname === "localhost") ? "http://localhost:3000" : "https://projekt-bazy-danych-backend.onrender.com";
    // przy deployu -> ustaw prawidłowe API (np. https://my-render-service.onrender.com)

    async function fetchUsers(q = "", typ = "") {
      const params = new URLSearchParams();
      if (q) params.set("q", q);
      if (typ) params.set("typ", typ);
      const res = await fetch(API + "/api/uzytkownicy?" + params.toString());
      return res.json();
    }

    async function renderUsers() {
      const q = document.getElementById("uzytk_q").value;
      const typ = document.getElementById("uzytk_typ").value;
      const users = await fetchUsers(q, typ);
      const container = document.getElementById("uzytk_lista");
      if (!users.length) { container.innerHTML = "<p>Brak wyników.</p>"; return; }
      let html = "<table><thead><tr><th>ID</th><th>Imię</th><th>Nazwisko</th><th>Email</th><th>Typ</th><th>Akcje</th></tr></thead><tbody>";
      users.forEach(u => {
        html += `<tr>
          <td>${u.id}</td>
          <td><input data-id="${u.id}" data-field="imie" value="${u.imie}" /></td>
          <td><input data-id="${u.id}" data-field="nazwisko" value="${u.nazwisko}" /></td>
          <td><input data-id="${u.id}" data-field="email" value="${u.email}" /></td>
          <td>${u.typ_konta}</td>
          <td>
            <button data-action="save" data-id="${u.id}">Zapisz</button>
            <button data-action="delete" data-id="${u.id}">Usuń</button>
          </td>
        </tr>`;
      });
      html += "</tbody></table>";
      container.innerHTML = html;

      container.querySelectorAll("button[data-action='save']").forEach(b => {
        b.onclick = async (e) => {
          const id = e.target.dataset.id;
          const row = e.target.closest("tr");
          const imie = row.querySelector("input[data-field='imie']").value;
          const nazwisko = row.querySelector("input[data-field='nazwisko']").value;
          const email = row.querySelector("input[data-field='email']").value;
          await fetch(API + "/api/uzytkownicy/" + id, {
            method: "PUT",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ imie, nazwisko, email })
          });
          alert("Zapisano");
          renderUsers();
        };
      });
      container.querySelectorAll("button[data-action='delete']").forEach(b => {
        b.onclick = async (e) => {
          if (!confirm("Na pewno usunąć?")) return;
          const id = e.target.dataset.id;
          await fetch(API + "/api/uzytkownicy/" + id, { method: "DELETE" });
          renderUsers();
        };
      });
    }

    document.getElementById("uzytk_szukaj").onclick = renderUsers;
    document.getElementById("dodaj_uzytkownika").onclick = async () => {
      const imie = document.getElementById("nowe_imie").value;
      const nazwisko = document.getElementById("nowe_nazwisko").value;
      const email = document.getElementById("nowy_email").value;
      const haslo = document.getElementById("nowe_haslo").value;
      const typ = document.getElementById("nowy_typ").value;
      const res = await fetch(API + "/api/uzytkownicy", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ imie, nazwisko, email, haslo, typ_konta: typ })
      });
      if (res.ok) {
        alert("Dodano użytkownika");
        renderUsers();
      } else {
        const err = await res.json();
        alert("Błąd: " + (err.error || "nieznany"));
      }
    };

    // ---------------------
    // Pytania (lista / dodawanie)
    // ---------------------
    async function loadBankiIKategorie() {
      const [bankiRes, katRes] = await Promise.all([fetch(API + "/api/banki"), fetch(API + "/api/kategorie")]);
      const banki = await bankiRes.json();
      const kat = await katRes.json();
      const sel = document.getElementById("pytanie_bank");
      const sel2 = document.getElementById("pytanie_bank_select");
      const sel3 = document.getElementById("pytanie_kat_select");
      [sel, sel2].forEach(s => {
        s.innerHTML = "<option value=''>Bank (wszystkie)</option>";
        banki.forEach(b => s.innerHTML += `<option value="${b.id_banku}">${b.nazwa || b.id_banku}</option>`);
      });
      sel3.innerHTML = "<option value=''>Kategoria</option>";
      kat.forEach(k => sel3.innerHTML += `<option value="${k.id_kategorii}">${k.nazwa}</option>`);
    }

    async function renderPytania() {
      const q = document.getElementById("pytanie_q").value;
      const id_banku = document.getElementById("pytanie_bank").value;
      const params = new URLSearchParams();
      if (q) params.set("q", q);
      if (id_banku) params.set("id_banku", id_banku);
      const res = await fetch(API + "/api/pytania?" + params.toString());
      const rows = await res.json();
      const cont = document.getElementById("pytania_lista");
      if (!rows.length) { cont.innerHTML = "<p>Brak pytań.</p>"; return; }
      let html = "<table><thead><tr><th>ID</th><th>Treść</th><th>Bank</th><th>Kategoria</th><th>Trudność</th><th>Akcje</th></tr></thead><tbody>";
      rows.forEach(r => {
        html += `<tr>
          <td>${r.id_pytania}</td>
          <td>${r.tresc}</td>
          <td>${r.bank_nazwa || r.id_banku || '-'}</td>
          <td>${r.kat_nazwa || r.id_kategorii || '-'}</td>
          <td>${r.trudnosc}</td>
          <td><button data-id="${r.id_pytania}" class="delp">Usuń</button></td>
        </tr>`;
      });
      html += "</tbody></table>";
      cont.innerHTML = html;
      cont.querySelectorAll(".delp").forEach(b => b.onclick = async (e) => {
        if (!confirm("Usuń pytanie?")) return;
        await fetch(API + "/api/pytania/" + e.target.dataset.id, { method: "DELETE" });
        renderPytania();
      });
    }

    document.getElementById("pytania_szukaj").onclick = renderPytania;
    document.getElementById("dodaj_pytanie").onclick = async () => {
      const tresc = document.getElementById("pytanie_tresc").value;
      const trudnosc = Number(document.getElementById("pytanie_trudnosc").value || 1);
      const id_banku = document.getElementById("pytanie_bank_select").value || null;
      const id_kategorii = document.getElementById("pytanie_kat_select").value || null;
      const res = await fetch(API + "/api/pytania", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ tresc, trudnosc, id_banku, id_kategorii })
      });
      if (res.ok) {
        alert("Dodano pytanie");
        renderPytania();
      } else {
        const err = await res.json();
        alert("Błąd: " + (err.error || "nieznany"));
      }
    };

    // init
    (async () => {
      await loadBankiIKategorie();
      await renderUsers();
      await renderPytania();
    })();
  </script>
</body>
</html>
