<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikacja kliencka ‚Äî U≈ºytkownicy (API + motyw)</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="logo"><div class="badge">AK</div><div class="title">Aplikacja kliencka ‚Äî U≈ºytkownicy</div></div>
    <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
      <div id="themeToggle" class="themeToggle" title="Prze≈ÇƒÖcz motyw">üåô <span id="themeLabel">Ciemny</span></div>
      <button id="btnAddOpen" class="btn">Dodaj</button>
    </div>
  </header>

  <div class="container" id="appRoot">
    <nav class="sidebar" aria-label="G≈Ç√≥wne menu">
      <div class="sectionTitle">Nawigacja</div>
      <div class="menu">
        <button data-view="browse" class="active">PrzeglƒÖdaj u≈ºytkownik√≥w</button>
        <button data-view="search">Wyszukaj (kryteria)</button>
        <button data-view="add">Dodaj nowego</button>
        <button data-view="report">Raport</button>
      </div>
      <hr style="margin:12px 0;border-color:rgba(0,0,0,0.04)">
      <div class="sectionTitle">Szybkie filtry</div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px">
        <button class="chip" data-filter="all">Wszystkie</button>
      </div>
    </nav>

    <main class="card" id="main">
      <div class="topbar">
        <div class="searchbar">
          <input id="q" placeholder="Szukaj po imieniu, nazwisku...">
          <input id="dateFrom" type="date">
          <input id="dateTo" type="date">
          <button id="btnSearch" class="btn ghost">Szukaj</button>
          <button id="btnClear" class="btn">Wyczy≈õƒá</button>
        </div>
        <div class="controls" aria-hidden>
          <div class="meta">Znaleziono: <span id="count">0</span></div>
        </div>
      </div>

      <div class="grid">
        <section class="list" id="listArea">
          <h3>Lista u≈ºytkownik√≥w</h3>
          <div id="items">≈Åadowanie...</div>
        </section>

        <aside style="background:rgba(255,255,255,0.02);padding:12px;border-radius:10px">
          <h4>Dodaj / Edytuj</h4>
          <form id="addForm" class="addForm" autocomplete="off">
            <input type="hidden" id="itemId">
            <label>Imiƒô<input id="imie" required placeholder="Imiƒô..."></label>
            <label>Nazwisko<input id="nazwisko" required placeholder="Nazwisko..."></label>
            <label>Email<input id="email" type="email" placeholder="adres@example.com"></label>
            <label>Data do≈ÇƒÖczenia<input id="data_dolaczenia" type="date" required></label>
            <label>Komentarz<textarea id="komentarz" rows="3" placeholder="Notatki..."></textarea></label>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button type="reset" class="btn ghost">Wyczy≈õƒá</button>
              <button type="submit" class="btn">Zapisz</button>
            </div>
          </form>
        </aside>
      </div>

      <section id="reportSection" class="report" style="margin-top:12px;display:none">
        <h3>Raport ‚Äî u≈ºytkownicy</h3>
        <div class="summary">
          <div class="stat"><div class="meta">Liczba u≈ºytkownik√≥w</div><div id="statCount" style="font-weight:700;font-size:20px">0</div></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="btnDownloadCSV" class="btn">Pobierz CSV</button>
          <button id="btnPrintReport" class="btn ghost">Drukuj raport</button>
        </div>
      </section>

    </main>
  </div>

  <footer>Wersja z API ‚Ä¢ Backend: Node.js + Express + sqlite3</footer>

  <script>
    /* ---------- Konfiguracja ---------- */
    const API_ROOT = "https://projekt-bazy-danych-backend.onrender.com/api/uzytkownicy";
    const STORAGE_FALLBACK_KEY = 'app_demo_items_v1'

    /* ---------- Motyw (light/dark) ---------- */
    const root = document.documentElement
    const themeToggle = document.getElementById('themeToggle')
    const themeLabel = document.getElementById('themeLabel')

    function applyTheme(theme){
      if(theme==='light'){
        document.body.setAttribute('data-theme','light')
        themeLabel.textContent = 'Jasny'
        themeToggle.textContent = '‚òÄÔ∏è Jasny'
      } else {
        document.body.removeAttribute('data-theme')
        themeLabel.textContent = 'Ciemny'
        themeToggle.textContent = 'üåô Ciemny'
      }
      localStorage.setItem('theme', theme)
    }
    themeToggle.addEventListener('click', ()=>{
      const cur = localStorage.getItem('theme') === 'light' ? 'dark' : 'light'
      applyTheme(cur)
    })
    // inicjalizacja
    applyTheme(localStorage.getItem('theme') || 'dark')

    /* ---------- Storage + fallback ---------- */
    async function fetchApi(path = '', opts = {}){
      try{
        const res = await fetch(path, opts)
        if(!res.ok) throw new Error('API error '+res.status)
        return await res.json()
      }catch(err){
        console.warn('API unavailable, using fallback:', err)
        return null
      }
    }

    function loadFallback(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_FALLBACK_KEY) || 'null') || [] }catch(e){return []}
    }
    function saveFallback(data){ localStorage.setItem(STORAGE_FALLBACK_KEY, JSON.stringify(data)) }

    /* ---------- Operacje CRUD (uzytkownicy) ---------- */
    async function getUsers(){
      const data = await fetchApi(API_ROOT)
      if(data) return data
      return loadFallback()
    }
    async function createUser(payload){
      const data = await fetchApi(API_ROOT, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
      if(data) return data
      const local = loadFallback(); payload.id = 'loc_'+Math.random().toString(36).slice(2,9); local.unshift(payload); saveFallback(local); return payload
    }
    async function updateUser(id,payload){
      const data = await fetchApi(API_ROOT+'/'+id, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
      if(data) return data
      const local = loadFallback(); const idx = local.findIndex(x=>x.id==id); if(idx>-1){local[idx]=payload; saveFallback(local)}; return payload
    }
    async function deleteUser(id){
      const data = await fetchApi(API_ROOT+'/'+id, {method:'DELETE'})
      if(data) return data
      const local = loadFallback(); const rest = local.filter(x=>x.id!=id); saveFallback(rest); return {ok:true}
    }

    /* ---------- UI: render, form, wyszukiwanie ---------- */
    const itemsEl = document.getElementById('items')
    const countEl = document.getElementById('count')
    const qEl = document.getElementById('q')
    const dateFromEl = document.getElementById('dateFrom')
    const dateToEl = document.getElementById('dateTo')
    const btnSearch = document.getElementById('btnSearch')
    const btnClear = document.getElementById('btnClear')
    const addForm = document.getElementById('addForm')
    const imieEl = document.getElementById('imie')
    const nazwiskoEl = document.getElementById('nazwisko')
    const emailEl = document.getElementById('email')
    const dataDolEl = document.getElementById('data_dolaczenia')
    const komentarzEl = document.getElementById('komentarz')
    const itemIdEl = document.getElementById('itemId')
    const reportSection = document.getElementById('reportSection')

    let items = []

    function escapeHtml(s){return String(s||'').replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
    function formatDate(d){if(!d) return ''; try{const dt=new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString('pl-PL')}catch(e){return d}}

    function renderList(list){
      itemsEl.innerHTML = ''
      if(!list || list.length===0){ itemsEl.innerHTML = '<div class="meta">Brak rekord√≥w</div>'; countEl.textContent = 0; return }
      list.forEach(it=>{
        const div = document.createElement('div'); div.className='cardItem'
        div.innerHTML = `
          <div>
            <div style="font-weight:600">${escapeHtml(it.imie+' '+(it.nazwisko||''))}</div>
            <div class="meta">${it.email||''} ‚Ä¢ ${formatDate(it.data_dolaczenia)} ‚Ä¢ ${escapeHtml(it.komentarz||'')}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn ghost" data-edit="${it.id}">Edytuj</button>
            <button class="btn" data-del="${it.id}">Usu≈Ñ</button>
          </div>`
        itemsEl.appendChild(div)
      })
      countEl.textContent = list.length
    }

    async function loadAndRender(){
      items = await getUsers()
      renderList(items)
      updateStats()
    }

    function applyFilters(){
      let list = [...items]
      const q = qEl.value.trim().toLowerCase()
      const df = dateFromEl.value
      const dtv = dateToEl.value
      if(q){ list = list.filter(i=> (i.imie||'').toLowerCase().includes(q) || (i.nazwisko||'').toLowerCase().includes(q) || (i.email||'').toLowerCase().includes(q) || (i.komentarz||'').toLowerCase().includes(q)) }
      if(df){ list = list.filter(i=> new Date(i.data_dolaczenia) >= new Date(df+'T00:00:00')) }
      if(dtv){ list = list.filter(i=> new Date(i.data_dolaczenia) <= new Date(dtv+'T23:59:59')) }
      renderList(list)
      return list
    }

    btnSearch.addEventListener('click', ()=>applyFilters())
    btnClear.addEventListener('click', ()=>{ qEl.value=''; dateFromEl.value=''; dateToEl.value=''; renderList(items) })

    addForm.addEventListener('submit', async (e)=>{
      e.preventDefault()
      const payload = { imie: imieEl.value.trim(), nazwisko: nazwiskoEl.value.trim(), email: emailEl.value.trim(), data_dolaczenia: dataDolEl.value, komentarz: komentarzEl.value.trim() }
      if(!payload.imie || !payload.nazwisko || !payload.data_dolaczenia){ alert('Uzupe≈Çnij wymagane pola'); return }
      const id = itemIdEl.value
      if(id){ payload.id = id; await updateUser(id,payload) }
      else { await createUser(payload) }
      addForm.reset(); itemIdEl.value=''; await loadAndRender()
    })

    itemsEl.addEventListener('click', async (e)=>{
      const edit = e.target.dataset.edit
      const del = e.target.dataset.del
      if(edit){ const it = items.find(x=>String(x.id)===String(edit)); if(it){ itemIdEl.value = it.id; imieEl.value = it.imie||''; nazwiskoEl.value = it.nazwisko||''; emailEl.value = it.email||''; dataDolEl.value = it.data_dolaczenia||''; komentarzEl.value = it.komentarz||''; window.scrollTo({top:0,behavior:'smooth'}) } }
      if(del){ if(!confirm('Czy na pewno usunƒÖƒá u≈ºytkownika?')) return; await deleteUser(del); await loadAndRender() }
    })

    document.querySelectorAll('.menu button').forEach(b=>b.addEventListener('click', ()=>{
      document.querySelectorAll('.menu button').forEach(x=>x.classList.remove('active'))
      b.classList.add('active')
      const view = b.dataset.view
      if(view==='report'){ reportSection.style.display='block' } else { reportSection.style.display='none' }
      if(view==='add'){ window.scrollTo({top:document.getElementById('addForm').offsetTop,behavior:'smooth'}) }
    }))

    document.getElementById('btnAddOpen').addEventListener('click', ()=>{ window.scrollTo({top:document.getElementById('addForm').offsetTop,behavior:'smooth'}) })

    function updateStats(){
      const list = items || []
      document.getElementById('statCount').textContent = list.length
    }

    document.getElementById('btnDownloadCSV').addEventListener('click', ()=>{
      const rows = [['id','imie','nazwisko','email','data_dolaczenia','komentarz']]
      items.forEach(i=> rows.push([i.id,i.imie,i.nazwisko,i.email,i.data_dolaczenia,i.komentarz]))
      const csv = rows.map(r=> r.map(c=> '"'+String(c||'').replace(/ "/g,'""')+'"').join(',')).join('');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='uzytkownicy.csv'; a.click(); URL.revokeObjectURL(url);
    })

    document.getElementById('btnPrintReport').addEventListener('click', ()=>{
      const w = window.open('','_blank')
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Raport u≈ºytkownik√≥w</title><style>body{font-family:Arial;padding:20px;color:#111}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd}</style></head><body><h1>Raport u≈ºytkownik√≥w</h1><p>Liczba: ${items.length}</p><table><thead><tr><th>Imiƒô</th><th>Nazwisko</th><th>Email</th><th>Data do≈ÇƒÖczenia</th><th>Komentarz</th></tr></thead><tbody>${items.map(i=>`<tr><td>${escapeHtml(i.imie)}</td><td>${escapeHtml(i.nazwisko)}</td><td>${escapeHtml(i.email)}</td><td>${escapeHtml(i.data_dolaczenia)}</td><td>${escapeHtml(i.komentarz)}</td></tr>`).join('')}</tbody></table></body></html>`
      w.document.write(html); w.document.close(); w.focus(); w.print()
    })

    // inicjalne za≈Çadowanie
    loadAndRender()
  </script>
</body>
</html>




